name: Sync Missing Invoices Direct

on:
  # Permettre l'exÃ©cution manuelle depuis l'interface GitHub
  workflow_dispatch:

jobs:
  direct_sync:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v3
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install requests python-dotenv pyairtable
        
    - name: Verify environment variables
      run: |
        echo "VÃ©rification des variables d'environnement..."
        if [ -z "${{ secrets.SELLSY_CLIENT_ID }}" ]; then echo "SELLSY_CLIENT_ID manquant"; exit 1; fi
        if [ -z "${{ secrets.SELLSY_CLIENT_SECRET }}" ]; then echo "SELLSY_CLIENT_SECRET manquant"; exit 1; fi
        if [ -z "${{ secrets.AIRTABLE_API_KEY }}" ]; then echo "AIRTABLE_API_KEY manquant"; exit 1; fi
        if [ -z "${{ secrets.AIRTABLE_BASE_ID }}" ]; then echo "AIRTABLE_BASE_ID manquant"; exit 1; fi
        if [ -z "${{ secrets.AIRTABLE_TABLE_NAME }}" ]; then echo "AIRTABLE_TABLE_NAME manquant"; exit 1; fi
        
    - name: Create direct_sync.py
      run: |
        cat > direct_sync.py << 'EOL'
        # Coller ici le contenu du script direct_sync.py
        import os
        import time
        import requests
        import base64
        from pyairtable import Table

        # RÃ©cupÃ©rer les variables d'environnement
        SELLSY_CLIENT_ID = os.environ.get("SELLSY_CLIENT_ID")
        SELLSY_CLIENT_SECRET = os.environ.get("SELLSY_CLIENT_SECRET")
        SELLSY_API_URL = os.environ.get("SELLSY_API_URL", "https://api.sellsy.com/v2")
        AIRTABLE_API_KEY = os.environ.get("AIRTABLE_API_KEY")
        AIRTABLE_BASE_ID = os.environ.get("AIRTABLE_BASE_ID")
        AIRTABLE_TABLE_NAME = os.environ.get("AIRTABLE_TABLE_NAME")
        PDF_STORAGE_DIR = "pdf_invoices"

        # VÃ©rifier que le rÃ©pertoire de stockage des PDF existe
        if not os.path.exists(PDF_STORAGE_DIR):
            os.makedirs(PDF_STORAGE_DIR)

        def get_access_token():
            """Obtient un token d'accÃ¨s Sellsy"""
            url = "https://login.sellsy.com/oauth2/access-tokens"
            
            # Authentification avec les identifiants client en Base64
            auth_string = f"{SELLSY_CLIENT_ID}:{SELLSY_CLIENT_SECRET}"
            auth_bytes = auth_string.encode('ascii')
            auth_b64 = base64.b64encode(auth_bytes).decode('ascii')
            
            headers = {
                "Authorization": f"Basic {auth_b64}",
                "Content-Type": "application/x-www-form-urlencoded",
                "Accept": "application/json"
            }
            
            data = "grant_type=client_credentials"
            
            print("Tentative d'authentification Ã  l'API Sellsy...")
            
            response = requests.post(url, headers=headers, data=data)
            if response.status_code == 200:
                token_data = response.json()
                access_token = token_data["access_token"]
                print("âœ… Token d'accÃ¨s obtenu avec succÃ¨s")
                return access_token
            else:
                print(f"âŒ Erreur d'authentification: {response.status_code}")
                print(response.text)
                raise Exception(f"Ã‰chec de l'authentification Sellsy")

        def get_all_invoices_once(token, max_size=500):
            """RÃ©cupÃ¨re toutes les factures en une seule requÃªte avec un nombre maximal"""
            headers = {
                "Authorization": f"Bearer {token}",
                "Content-Type": "application/json",
                "Accept": "application/json"
            }
            
            # ParamÃ¨tres de recherche - rÃ©cupÃ©rer le maximum en une fois
            params = {
                "limit": max_size  # RÃ©cupÃ©rer le maximum de factures en une seule fois
            }
            
            url = f"{SELLSY_API_URL}/invoices"
            print(f"RÃ©cupÃ©ration de toutes les factures (max {max_size}) en une seule requÃªte...")
            
            response = requests.get(url, headers=headers, params=params)
            if response.status_code == 200:
                data = response.json()
                invoices = data.get("data", [])
                print(f"âœ… {len(invoices)} factures rÃ©cupÃ©rÃ©es en une seule requÃªte")
                return invoices
            else:
                print(f"âŒ Erreur lors de la rÃ©cupÃ©ration des factures: {response.status_code}")
                print(response.text)
                return []

        def get_invoice_details(token, invoice_id):
            """RÃ©cupÃ¨re les dÃ©tails d'une facture spÃ©cifique"""
            headers = {
                "Authorization": f"Bearer {token}",
                "Accept": "application/json"
            }
            
            url = f"{SELLSY_API_URL}/invoices/{invoice_id}"
            response = requests.get(url, headers=headers)
            
            if response.status_code == 200:
                data = response.json()
                if "data" in data:
                    return data.get("data", {})
                else:
                    return data
            else:
                print(f"âŒ Impossible de rÃ©cupÃ©rer les dÃ©tails de la facture {invoice_id}")
                return None

        def format_invoice_for_airtable(invoice):
            """Convertit une facture Sellsy au format Airtable"""
            if not invoice:
                return None
            
            # RÃ©cupÃ©rer l'ID client et le nom du client
            client_id = None
            client_name = ""
            
            if "relation" in invoice:
                if "id" in invoice["relation"]:
                    client_id = str(invoice["relation"]["id"])
                if "name" in invoice["relation"]:
                    client_name = invoice["relation"]["name"]
            elif "related" in invoice:
                for related in invoice.get("related", []):
                    if related.get("type") == "individual" or related.get("type") == "corporation":
                        client_id = str(related.get("id", ""))
                        client_name = related.get("name", "")
                        break
                if not client_name:
                    client_name = invoice.get("company_name", invoice.get("client_name", "Client #" + str(client_id) if client_id else ""))
            
            # Gestion de la date
            created_date = ""
            for date_field in ["created_at", "date", "created"]:
                if date_field in invoice and invoice[date_field]:
                    created_date = invoice[date_field]
                    break
            
            if created_date and "T" in created_date:
                created_date = created_date.split("T")[0]
            else:
                created_date = time.strftime("%Y-%m-%d")
            
            # RÃ©cupÃ©ration des montants
            montant_ht = 0
            montant_ttc = 0
            
            if "amounts" in invoice:
                amounts = invoice["amounts"]
                for key in ["total_excluding_tax", "total_excl_tax", "tax_excl", "total_raw_excl_tax"]:
                    if key in amounts and amounts[key] is not None:
                        montant_ht = amounts[key]
                        break
                
                for key in ["total_including_tax", "total_incl_tax", "tax_incl", "total_incl_tax"]:
                    if key in amounts and amounts[key] is not None:
                        montant_ttc = amounts[key]
                        break
            
            # Fallbacks pour les montants
            if montant_ht == 0 and "amount" in invoice and "tax_excl" in invoice["amount"]:
                montant_ht = invoice["amount"]["tax_excl"]
                
            if montant_ttc == 0 and "amount" in invoice and "tax_incl" in invoice["amount"]:
                montant_ttc = invoice["amount"]["tax_incl"]
            
            if montant_ht == 0 and "total_amount_without_taxes" in invoice:
                montant_ht = invoice["total_amount_without_taxes"]
                
            if montant_ttc == 0 and "total_amount_with_taxes" in invoice:
                montant_ttc = invoice["total_amount_with_taxes"]
            
            # RÃ©cupÃ©ration du numÃ©ro de facture
            reference = ""
            for ref_field in ["reference", "number", "decimal_number"]:
                if ref_field in invoice and invoice[ref_field]:
                    reference = invoice[ref_field]
                    break
                
            # RÃ©cupÃ©ration du statut
            status = invoice.get("status", "")
            
            # RÃ©cupÃ©ration du lien PDF direct
            pdf_link = invoice.get("pdf_link", "")
            
            # Conversion des montants en float
            try:
                montant_ht = float(montant_ht) if montant_ht else 0.0
                montant_ttc = float(montant_ttc) if montant_ttc else 0.0
            except (ValueError, TypeError):
                montant_ht = 0.0
                montant_ttc = 0.0
            
            # CrÃ©ation du dictionnaire pour Airtable
            result = {
                "ID_Facture": str(invoice.get("id", "")),
                "NumÃ©ro": reference,
                "Date": created_date,
                "Client": client_name,
                "ID_Client_Sellsy": client_id,
                "Montant_HT": montant_ht,
                "Montant_TTC": montant_ttc,
                "Statut": status,
                "URL": f"https://go.sellsy.com/document/{invoice.get('id', '')}"
            }
            
            # Ajouter le lien PDF si disponible
            if pdf_link:
                result["PDF_URL"] = pdf_link
            
            return result

        def find_invoice_by_id(table, sellsy_id):
            """Recherche une facture dans Airtable par son ID Sellsy"""
            if not sellsy_id:
                return None
                
            sellsy_id = str(sellsy_id)  # Conversion en chaÃ®ne
            formula = f"{{ID_Facture}}='{sellsy_id}'"
            
            try:
                records = table.all(formula=formula)
                return records[0] if records else None
            except Exception as e:
                print(f"âŒ Erreur lors de la recherche: {e}")
                return None

        def insert_or_update_invoice(table, invoice_data):
            """InsÃ¨re ou met Ã  jour une facture dans Airtable"""
            if not invoice_data:
                return None
                
            sellsy_id = str(invoice_data.get("ID_Facture", ""))
            if not sellsy_id:
                return None
            
            try:
                existing_record = find_invoice_by_id(table, sellsy_id)

                if existing_record:
                    record_id = existing_record["id"]
                    print(f"ðŸ”„ Mise Ã  jour de la facture {sellsy_id}...")
                    table.update(record_id, invoice_data)
                    return record_id
                else:
                    print(f"âž• Ajout de la facture {sellsy_id}...")
                    record = table.create(invoice_data)
                    return record['id']
            except Exception as e:
                print(f"âŒ Erreur: {e}")
                return None

        def main():
            """Fonction principale qui exÃ©cute la synchronisation complÃ¨te"""
            print("ðŸš€ DÃ©but de la synchronisation directe des factures...")
            
            # Obtenir un token d'accÃ¨s
            access_token = get_access_token()
            
            # RÃ©cupÃ©rer toutes les factures en une seule requÃªte
            invoices = get_all_invoices_once(access_token)
            
            if not invoices:
                print("âŒ Aucune facture rÃ©cupÃ©rÃ©e, fin du processus")
                return
            
            print(f"Traitement de {len(invoices)} factures...")
            
            # Initialiser la connexion Ã  Airtable
            airtable_table = Table(AIRTABLE_API_KEY, AIRTABLE_BASE_ID, AIRTABLE_TABLE_NAME)
            
            # Compteurs pour le suivi
            success_count = 0
            error_count = 0
            
            # Traiter chaque facture
            for idx, invoice in enumerate(invoices):
                try:
                    invoice_id = str(invoice["id"])
                    print(f"\nFacture {idx+1}/{len(invoices)} - ID: {invoice_id}")
                    
                    # RÃ©cupÃ©rer les dÃ©tails complets de la facture
                    invoice_details = get_invoice_details(access_token, invoice_id)
                    source_data = invoice_details if invoice_details else invoice
                    
                    # Formater pour Airtable
                    formatted_invoice = format_invoice_for_airtable(source_data)
                    
                    if formatted_invoice:
                        # InsÃ©rer ou mettre Ã  jour dans Airtable
                        record_id = insert_or_update_invoice(airtable_table, formatted_invoice)
                        if record_id:
                            success_count += 1
                            print(f"âœ… Facture {invoice_id} traitÃ©e avec succÃ¨s")
                        else:
                            error_count += 1
                    else:
                        print(f"âš ï¸ Impossible de formater la facture {invoice_id}")
                        error_count += 1
                except Exception as e:
                    print(f"âŒ Erreur: {e}")
                    error_count += 1
            
            print(f"\nâœ… Synchronisation terminÃ©e: {success_count} factures traitÃ©es avec succÃ¨s, {error_count} erreurs")

        if __name__ == "__main__":
            main()
        EOL
        
    - name: Run direct sync
      env:
        SELLSY_CLIENT_ID: ${{ secrets.SELLSY_CLIENT_ID }}
        SELLSY_CLIENT_SECRET: ${{ secrets.SELLSY_CLIENT_SECRET }}
        SELLSY_API_URL: ${{ secrets.SELLSY_API_URL || 'https://api.sellsy.com/v2' }}
        AIRTABLE_API_KEY: ${{ secrets.AIRTABLE_API_KEY }}
        AIRTABLE_BASE_ID: ${{ secrets.AIRTABLE_BASE_ID }}
        AIRTABLE_TABLE_NAME: ${{ secrets.AIRTABLE_TABLE_NAME }}
      run: |
        echo "Variables d'environnement configurÃ©es."
        echo "DÃ©but de la synchronisation directe des factures..."
        python direct_sync.py
        
    - name: Log completion
      run: echo "Synchronisation directe des factures terminÃ©e."
